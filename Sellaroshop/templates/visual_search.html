{% extends 'base.html' %}
{% load static %}

{% block title %}REAL Visual Search - Sellaro{% endblock %}

{% block extra_css %}
<style>
    /* ========== RESET & VARIABLES ========== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
        --primary: #3a86ff;
        --secondary: #8338ec;
        --accent: #ff006e;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --shadow: 0 5px 15px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    body {
        background-color: #ffffff;
        color: var(--dark);
        line-height: 1.6;
        overflow-x: hidden;
    }

    .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }

    /* ========== BACK BUTTON ========== */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--primary);
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        text-decoration: none;
        transition: var(--transition);
        border: 2px solid transparent;
        font-weight: 600;
        margin: 20px 0;
    }

    .back-button:hover {
        background: white;
        color: var(--primary);
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    /* ========== HERO SECTION ========== */
    .visual-search-hero {
        background: linear-gradient(135deg, var(--accent), var(--secondary));
        color: white;
        padding: 80px 0;
        text-align: center;
        margin-bottom: 40px;
    }

    .visual-search-hero h1 {
        font-size: 3.5rem;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .visual-search-hero p {
        font-size: 1.3rem;
        max-width: 600px;
        margin: 0 auto;
        opacity: 0.9;
    }

    /* ========== UPLOAD OPTIONS ========== */
    .upload-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-bottom: 50px;
    }

    .upload-option {
        background: white;
        border-radius: 15px;
        padding: 40px 30px;
        text-align: center;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border: 2px solid transparent;
        cursor: pointer;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .upload-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(to right, var(--primary), var(--accent));
        transform: scaleX(0);
        transition: var(--transition);
    }

    .upload-option:hover {
        transform: translateY(-10px);
        border-color: var(--primary);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .upload-option:hover::before {
        transform: scaleX(1);
    }

    .upload-option.active {
        border-color: var(--accent);
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    }

    .upload-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        color: var(--primary);
        transition: var(--transition);
    }

    .upload-option:hover .upload-icon {
        transform: scale(1.1);
        color: var(--accent);
    }

    .upload-option h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: var(--dark);
    }

    .upload-option p {
        color: var(--gray);
        margin-bottom: 20px;
    }

    .upload-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .upload-btn:hover {
        background: #2a75e6;
        transform: translateY(-2px);
    }

    .upload-btn.secondary {
        background: var(--accent);
    }

    .upload-btn.secondary:hover {
        background: #e0005e;
    }

    /* ========== PREVIEW AREAS ========== */
    .preview-area {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: var(--shadow);
        margin-bottom: 40px;
        text-align: center;
        display: none;
    }

    .preview-area.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .preview-title {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: var(--dark);
    }

    .image-preview {
        max-width: 400px;
        max-height: 400px;
        margin: 0 auto 20px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border: 2px dashed #ddd;
    }

    .image-preview img, .image-preview video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    /* ========== AI DETECTION RESULTS ========== */
    .detection-results {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: var(--shadow);
    }

    .detection-results.active {
        display: block;
    }

    .detection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        background: var(--light);
        border-radius: 10px;
        border-left: 4px solid var(--primary);
    }

    .detection-label {
        font-weight: 600;
        color: var(--dark);
    }

    .detection-confidence {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .confidence-bar {
        width: 100px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .confidence-value {
        font-weight: 600;
        color: var(--dark);
        min-width: 50px;
    }

    /* ========== CAMERA SECTION ========== */
    #cameraView {
        width: 100%;
        height: 300px;
        background: var(--light);
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
        border: 2px dashed #ddd;
    }

    #cameraView.active {
        display: block;
    }

    .camera-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    /* ========== LOADING ANIMATION ========== */
    .loading {
        display: none;
        text-align: center;
        padding: 40px;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--light);
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ========== RESULTS SECTION ========== */
    .results-section {
        display: none;
        padding: 40px 0;
    }

    .results-section.active {
        display: block;
    }

    .results-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .results-header h2 {
        font-size: 2.5rem;
        color: var(--dark);
        margin-bottom: 15px;
    }

    .results-header p {
        color: var(--gray);
        font-size: 1.1rem;
    }

    /* ========== PRODUCTS GRID ========== */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
        width: 100%;
    }

    .product-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .product-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .product-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: var(--accent);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 2;
    }

    .product-image {
        height: 220px;
        background: linear-gradient(135deg, var(--light), #e9ecef);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
    }

    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
    }

    .product-card:hover .product-image img {
        transform: scale(1.05);
    }

    .product-info {
        padding: 25px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .product-info h3 {
        margin-bottom: 12px;
        font-size: 1.3rem;
        color: var(--dark);
    }

    .product-info p {
        color: var(--gray);
        margin-bottom: 20px;
        font-size: 0.95rem;
        line-height: 1.5;
        flex-grow: 1;
    }

    .product-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .old-price {
        font-size: 1rem;
        color: var(--gray);
        text-decoration: line-through;
    }

    .similarity-score {
        display: inline-block;
        background: var(--success);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .product-rating {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
    }

    .stars {
        color: var(--warning);
    }

    .rating-count {
        color: var(--gray);
        font-size: 0.9rem;
    }

    .add-to-cart {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        width: 100%;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: auto;
    }

    .add-to-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(58,134,255,0.3);
    }

    .add-to-cart.added {
        background: var(--success);
    }

    .add-to-cart:disabled {
        background: var(--gray);
        cursor: not-allowed;
        transform: none;
    }

    .add-to-cart:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    /* ========== TOAST NOTIFICATION ========== */
    .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--success);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 3000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }

    .toast.error {
        background: var(--danger);
    }

    .toast.warning {
        background: var(--warning);
        color: var(--dark);
    }

    .toast.info {
        background: var(--primary);
    }

    /* ========== UPLOAD PROGRESS ========== */
    .upload-progress {
        margin: 20px 0;
        width: 100%;
    }

    .progress-bar {
        width: 100%;
        height: 10px;
        background: var(--light);
        border-radius: 5px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(to right, var(--primary), var(--accent));
        width: 0%;
        transition: width 0.3s ease;
    }

    /* ========== NO RESULTS MESSAGE ========== */
    .no-results {
        text-align: center;
        padding: 60px;
        background: var(--light);
        border-radius: 15px;
        display: none;
    }

    .no-results.active {
        display: block;
    }

    .no-results-icon {
        font-size: 4rem;
        color: var(--gray);
        margin-bottom: 20px;
    }

    /* ========== AI STATUS ========== */
    .ai-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        background: var(--light);
        border-radius: 20px;
        font-size: 0.9rem;
        margin-bottom: 20px;
    }

    .ai-status.active {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .ai-status.loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    /* ========== MATCH STATS ========== */
    .match-details {
        background: var(--light);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
    }

    .match-stats {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .stat-item {
        text-align: center;
        flex: 1;
        min-width: 120px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .stat-label {
        color: var(--gray);
        font-size: 0.9rem;
        margin-top: 5px;
    }

    /* ========== RESPONSIVE DESIGN ========== */
    @media (max-width: 1024px) {
        .visual-search-hero {
            padding: 60px 0;
        }
        
        .visual-search-hero h1 {
            font-size: 3rem;
        }
    }

    @media (max-width: 768px) {
        .visual-search-hero {
            padding: 50px 0;
        }

        .visual-search-hero h1 {
            font-size: 2.5rem;
        }

        .visual-search-hero p {
            font-size: 1.1rem;
        }

        .upload-options {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .preview-controls, .camera-controls {
            flex-direction: column;
            align-items: center;
        }

        .upload-btn, .preview-controls button, .camera-controls button {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }

        .products-grid {
            grid-template-columns: 1fr;
        }

        .preview-area {
            padding: 20px;
        }

        .image-preview {
            max-width: 100%;
        }

        .match-stats {
            flex-direction: column;
            align-items: center;
        }

        .stat-item {
            min-width: 200px;
        }
    }

    @media (max-width: 480px) {
        .visual-search-hero {
            padding: 40px 0;
        }
        
        .visual-search-hero h1 {
            font-size: 2rem;
        }

        .product-price {
            font-size: 1.3rem;
        }

        .stat-value {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- TensorFlow.js for REAL AI -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
{% endblock %}

{% block content %}
<!-- ========== MAIN CONTENT ========== -->

<!-- Visual Search Hero Section -->
<section class="visual-search-hero">
    <div class="container">
        <div class="visual-search-hero-content">
            <h1><i class="fas fa-robot"></i> REAL Visual Search</h1>
            <p>Powered by TensorFlow.js AI - Actual image recognition</p>
            <div class="ai-status" id="aiStatus">
                <i class="fas fa-microchip"></i>
                <span id="aiStatusText">Loading AI models...</span>
            </div>
        </div>
    </div>
</section>

<!-- Main Content Section -->
<section class="section">
    <div class="container">
        <!-- Upload Options -->
        <div class="upload-options">
            <div class="upload-option active" onclick="selectUploadOption('upload')">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Upload Image</h3>
                <p>Upload a photo for AI analysis</p>
                <button class="upload-btn" onclick="triggerFileUpload()">
                    <i class="fas fa-upload"></i> Choose Image
                </button>
                <input type="file" id="fileUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            </div>

            <div class="upload-option" onclick="selectUploadOption('camera')">
                <div class="upload-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <h3>Take Photo</h3>
                <p>Capture live image for analysis</p>
                <button class="upload-btn secondary" onclick="startCamera()">
                    <i class="fas fa-camera"></i> Open Camera
                </button>
            </div>

            <div class="upload-option" onclick="selectUploadOption('url')">
                <div class="upload-icon">
                    <i class="fas fa-link"></i>
                </div>
                <h3>Image URL</h3>
                <p>Analyze image from URL</p>
                <button class="upload-btn" onclick="showUrlInput()">
                    <i class="fas fa-globe"></i> Enter URL
                </button>
            </div>
        </div>

        <!-- URL Input Section -->
        <div class="preview-area" id="urlInputSection">
            <h3 class="preview-title">Enter Image URL</h3>
            <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg" 
                   style="width: 100%; padding: 15px; margin: 20px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem;">
            <div class="preview-controls">
                <button class="upload-btn" onclick="loadImageFromUrl()">
                    <i class="fas fa-search"></i> Analyze Image
                </button>
                <button class="upload-btn secondary" onclick="hideUrlInput()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>

        <!-- Image Preview Section -->
        <div class="preview-area" id="imagePreview">
            <h3 class="preview-title">Image Preview</h3>
            <div class="image-preview">
                <img id="previewImage" src="" alt="Preview" onerror="this.src='https://via.placeholder.com/400x400?text=Image+Not+Loaded'">
            </div>
            
            <!-- Upload Progress -->
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">Uploading...</p>
            </div>

            <div class="preview-controls">
                <button class="upload-btn" id="analyzeBtn" onclick="runAIanalysis()">
                    <i class="fas fa-brain"></i> Analyze with AI
                </button>
                <button class="upload-btn secondary" onclick="clearImage()">
                    <i class="fas fa-times"></i> Clear Image
                </button>
            </div>
        </div>

        <!-- AI Detection Results -->
        <div class="detection-results" id="detectionResults">
            <h3 class="preview-title">
                <i class="fas fa-robot"></i> AI Detection Results
            </h3>
            <div id="detectionList">
                <!-- AI results will appear here -->
            </div>
            <div class="preview-controls">
                <button class="upload-btn" id="searchBtn" onclick="findSimilarProducts()">
                    <i class="fas fa-search"></i> Find Similar Products
                </button>
            </div>
        </div>

        <!-- Camera Section -->
        <div class="preview-area" id="cameraSection">
            <h3 class="preview-title">Camera</h3>
            <video id="cameraView" autoplay playsinline></video>
            <canvas id="photoCanvas" style="display: none;"></canvas>
            <div class="camera-controls">
                <button class="upload-btn secondary" onclick="capturePhoto()">
                    <i class="fas fa-camera"></i> Capture Photo
                </button>
                <button class="upload-btn" onclick="stopCamera()">
                    <i class="fas fa-times"></i> Close Camera
                </button>
            </div>
        </div>

        <!-- Loading Animation -->
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Running AI analysis</p>
            <div class="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="searchProgressFill"></div>
                </div>
                <p id="searchProgressText">Loading AI model...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Results will be inserted here -->
        </div>

        <!-- No Results Message -->
        <div class="no-results" id="noResultsSection">
            <div class="no-results-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>No Similar Products Found</h3>
            <p>AI couldn't find matching products. Try a different image.</p>
            <button class="upload-btn" onclick="clearImage()" style="margin-top: 20px;">
                <i class="fas fa-upload"></i> Try Another Image
            </button>
        </div>
    </div>
</section>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- ========== JAVASCRIPT WITH REAL AI ========== -->
<script>
    // ========== GLOBAL VARIABLES ==========
    let currentStream = null;
    let selectedImage = null;
    let aiDetections = [];
    let mobileNetModel = null;
    let cocoSsdModel = null;
    let aiModelsLoaded = false;
    
    // REAL PRODUCT DATABASE WITH ACTUAL CATEGORIES
    const productDatabase = [
        { 
            id: 1,
            name: "Sony WH-1000XM4 Wireless Headphones", 
            price: 349.99, 
            oldPrice: 399.99, 
            rating: 4.8, 
            reviews: 12456, 
            image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Electronics",
            subCategory: "Audio",
            aiTags: ["headphones", "headset", "earphones", "audio device", "music player", "wireless", "bluetooth", "over-ear"],
            colors: ["black", "silver"],
            material: ["plastic", "metal"],
            shape: "circular"
        },
        { 
            id: 2,
            name: "Apple Watch Series 8", 
            price: 399.99, 
            oldPrice: 429.99, 
            rating: 4.7, 
            reviews: 8923, 
            image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Electronics",
            subCategory: "Wearables",
            aiTags: ["watch", "smartwatch", "wristwatch", "digital watch", "fitness tracker", "wearable", "watch strap"],
            colors: ["black", "silver", "gold"],
            material: ["metal", "glass"],
            shape: "rectangular"
        },
        { 
            id: 3,
            name: "Nike Air Max 270 Running Shoes", 
            price: 149.99, 
            oldPrice: 179.99, 
            rating: 4.6, 
            reviews: 15432, 
            image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Fashion",
            subCategory: "Footwear",
            aiTags: ["shoes", "sneakers", "running shoes", "athletic shoes", "trainers", "footwear", "sports shoes"],
            colors: ["white", "black", "red"],
            material: ["fabric", "rubber"],
            shape: "footwear"
        },
        { 
            id: 4,
            name: "Gucci GG Marmont Matelassé Bag", 
            price: 2290.00, 
            oldPrice: 2590.00, 
            rating: 4.5, 
            reviews: 1245, 
            image: "https://images.unsplash.com/photo-1584917865442-de89df76afd3?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Fashion",
            subCategory: "Bags",
            aiTags: ["bag", "handbag", "purse", "tote bag", "shoulder bag", "leather bag", "designer bag"],
            colors: ["brown", "black", "beige"],
            material: ["leather"],
            shape: "rectangular"
        },
        { 
            id: 5,
            name: "ASUS ROG Zephyrus Gaming Laptop", 
            price: 1499.99, 
            oldPrice: 1699.99, 
            rating: 4.7, 
            reviews: 2892, 
            image: "https://images.unsplash.com/photo-1603302576837-37561b2e2302?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Electronics",
            subCategory: "Computers",
            aiTags: ["laptop", "computer", "notebook", "gaming laptop", "keyboard", "screen", "portable computer"],
            colors: ["black", "gray"],
            material: ["metal", "plastic"],
            shape: "rectangular"
        },
        { 
            id: 6,
            name: "iPhone 14 Pro Max", 
            price: 1099.99, 
            oldPrice: 1199.99, 
            rating: 4.8, 
            reviews: 13124, 
            image: "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Electronics",
            subCategory: "Mobile",
            aiTags: ["phone", "smartphone", "mobile phone", "cellphone", "iphone", "device", "handheld"],
            colors: ["black", "silver", "gold"],
            material: ["glass", "metal"],
            shape: "rectangular"
        },
        { 
            id: 7,
            name: "Ray-Ban Aviator Sunglasses", 
            price: 153.00, 
            oldPrice: 189.00, 
            rating: 4.4, 
            reviews: 4856, 
            image: "https://images.unsplash.com/photo-1572635196237-14b3f281503f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Fashion",
            subCategory: "Eyewear",
            aiTags: ["sunglasses", "glasses", "eyewear", "shades", "sun glasses", "aviator", "frames"],
            colors: ["black", "gold", "silver"],
            material: ["metal", "glass"],
            shape: "sunglasses"
        },
        { 
            id: 8,
            name: "Nespresso Vertuo Coffee Machine", 
            price: 199.99, 
            oldPrice: 249.99, 
            rating: 4.6, 
            reviews: 8123, 
            image: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80", 
            category: "Home",
            subCategory: "Appliances",
            aiTags: ["coffee maker", "coffee machine", "espresso machine", "coffee pot", "brewer", "appliance", "kitchen appliance"],
            colors: ["black", "silver", "red"],
            material: ["plastic", "metal"],
            shape: "rectangular"
        }
    ];

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("Initializing Visual Search...");
        updateAIStatus("Loading TensorFlow.js models...", "loading");
        
        try {
            // Load TensorFlow.js models
            await loadAIModels();
            updateAIStatus("AI Models Ready ✓", "active");
            showToast("TensorFlow.js models loaded successfully!", "info");
        } catch (error) {
            console.error("AI Model Loading Error:", error);
            updateAIStatus("AI Failed to Load ✗", "error");
            showToast("Failed to load AI models. Using fallback detection.", "warning");
            
            // Set up fallback
            setupFallbackDetection();
        }
    });

    // ========== REAL AI MODEL LOADING ==========
    async function loadAIModels() {
        updateLoading("Initializing TensorFlow.js", "Setting up neural networks...");
        
        try {
            // Check if TensorFlow is available
            if (typeof tf === 'undefined') {
                throw new Error("TensorFlow.js not loaded - check CDN");
            }
            
            console.log("TensorFlow.js version:", tf.version.tfjs);
            console.log("Available backends:", tf.getBackend());
            
            // Test TensorFlow backend
            const testTensor = tf.tensor([1, 2, 3]);
            console.log("TensorFlow test successful:", testTensor.dataSync());
            testTensor.dispose();
            
            // Load MobileNet for image classification
            console.log("Loading MobileNet model...");
            try {
                mobileNetModel = await mobilenet.load({
                    version: 2,
                    alpha: 1.0
                });
                console.log("MobileNet loaded successfully");
            } catch (mobilenetError) {
                console.warn("MobileNet failed, trying version 1:", mobilenetError);
                mobileNetModel = await mobilenet.load({
                    version: 1,
                    alpha: 1.0
                });
            }
            
            // Load COCO-SSD for object detection
            console.log("Loading COCO-SSD model...");
            try {
                cocoSsdModel = await cocoSsd.load();
                console.log("COCO-SSD loaded successfully");
            } catch (cocoError) {
                console.warn("COCO-SSD failed:", cocoError);
                cocoSsdModel = null;
            }
            
            console.log("AI Models loaded:", {
                mobileNet: mobileNetModel !== null,
                cocoSsd: cocoSsdModel !== null
            });
            
            aiModelsLoaded = mobileNetModel !== null;
            return true;
            
        } catch (error) {
            console.error("Failed to load AI models:", error);
            throw error;
        }
    }

    // ========== FALLBACK DETECTION (if AI fails) ==========
    function setupFallbackDetection() {
        console.log("Setting up fallback detection system");
        aiModelsLoaded = false;
        document.getElementById('aiStatusText').textContent = "Fallback Mode Active";
        document.getElementById('aiStatus').className = 'ai-status warning';
    }

    // ========== VISUAL SEARCH FUNCTIONS ==========
    function selectUploadOption(option) {
        document.querySelectorAll('.upload-option').forEach(opt => {
            opt.classList.remove('active');
        });
        
        event.currentTarget.classList.add('active');

        // Hide all sections
        document.getElementById('urlInputSection').classList.remove('active');
        document.getElementById('imagePreview').classList.remove('active');
        document.getElementById('cameraSection').classList.remove('active');
        document.getElementById('resultsSection').classList.remove('active');
        document.getElementById('noResultsSection').classList.remove('active');
        document.getElementById('detectionResults').classList.remove('active');

        if (option === 'url') {
            document.getElementById('urlInputSection').classList.add('active');
        }
    }

    function triggerFileUpload() {
        document.getElementById('fileUpload').click();
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            if (!file.type.match('image.*')) {
                showToast('Please select an image file (JPEG, PNG, etc.)', 'error');
                return;
            }
            
            showUploadProgress();
            
            simulateProgress(() => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('imagePreview').classList.add('active');
                    document.getElementById('urlInputSection').classList.remove('active');
                    selectedImage = e.target.result;
                    
                    // Reset detection results
                    document.getElementById('detectionResults').classList.remove('active');
                    document.getElementById('resultsSection').classList.remove('active');
                    
                    showToast('Image uploaded! Click "Analyze with AI"', 'success');
                    hideUploadProgress();
                    
                    // Enable analyze button
                    document.getElementById('analyzeBtn').disabled = false;
                };
                reader.onerror = function() {
                    showToast('Failed to read image file', 'error');
                    hideUploadProgress();
                };
                reader.readAsDataURL(file);
            });
        }
    }

    // ========== REAL AI ANALYSIS ==========
    async function runAIanalysis() {
        const previewImage = document.getElementById('previewImage').src;
        if (!previewImage || previewImage === '' || previewImage.includes('placeholder')) {
            showToast('Please select an image first', 'error');
            return;
        }

        // Disable analyze button during processing
        const analyzeBtn = document.getElementById('analyzeBtn');
        const originalText = analyzeBtn.innerHTML;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        analyzeBtn.disabled = true;

        // Show loading
        document.getElementById('loadingSection').classList.add('active');
        updateLoading("Running AI Analysis", "Processing image with neural networks...");

        try {
            // Create image element
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = previewImage;
            
            // Wait for image to load
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = () => reject(new Error("Failed to load image"));
                setTimeout(() => reject(new Error("Image loading timeout")), 10000);
            });

            let classifications = [];
            let detections = [];

            if (aiModelsLoaded && mobileNetModel) {
                // Use TensorFlow.js models
                try {
                    // Run classification
                    classifications = await mobileNetModel.classify(img);
                    console.log("MobileNet classifications:", classifications);
                    
                    // Run object detection if available
                    if (cocoSsdModel) {
                        try {
                            detections = await cocoSsdModel.detect(img);
                            console.log("COCO-SSD detections:", detections);
                        } catch (detectError) {
                            console.warn("COCO-SSD detection failed:", detectError);
                        }
                    }
                    
                } catch (tfError) {
                    console.error("TensorFlow analysis failed:", tfError);
                    // Fall back to simulated detection
                    [classifications, detections] = await simulateAIDetection(img);
                }
            } else {
                // Use simulated detection
                [classifications, detections] = await simulateAIDetection(img);
            }

            // Process results
            aiDetections = processAIDetections(classifications, detections);
            console.log("Processed detections:", aiDetections);
            
            // Hide loading
            document.getElementById('loadingSection').classList.remove('active');
            
            // Show detection results
            displayDetectionResults(aiDetections);
            
            showToast(`AI detected ${aiDetections.length} objects!`, 'info');
            
            // Enable search button
            document.getElementById('searchBtn').disabled = false;

        } catch (error) {
            console.error("AI analysis error:", error);
            document.getElementById('loadingSection').classList.remove('active');
            
            // Try simulated detection as last resort
            try {
                const img = new Image();
                img.src = previewImage;
                await img.decode();
                
                const [classifications, detections] = await simulateAIDetection(img);
                aiDetections = processAIDetections(classifications, detections);
                displayDetectionResults(aiDetections);
                showToast(`Simulated detection found ${aiDetections.length} objects`, 'warning');
                
                // Enable search button
                document.getElementById('searchBtn').disabled = false;
            } catch (fallbackError) {
                showToast('Analysis failed. Please try another image.', 'error');
            }
        } finally {
            // Re-enable analyze button
            analyzeBtn.innerHTML = originalText;
            analyzeBtn.disabled = false;
        }
    }

    // ========== SIMULATED AI DETECTION (fallback) ==========
    async function simulateAIDetection(img) {
        console.log("Using simulated AI detection");
        
        // Simulate processing time
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Common objects that might be in images
        const commonObjects = [
            "headphones", "watch", "smartwatch", "shoes", "sneakers", "bag", "handbag", 
            "laptop", "computer", "phone", "smartphone", "sunglasses", "glasses",
            "coffee machine", "coffee maker", "electronics", "fashion", "clothing",
            "accessory", "device", "gadget", "wearable", "footwear", "eyewear"
        ];
        
        // Get image dimensions for context
        const width = img.width || 500;
        const height = img.height || 500;
        
        // Randomly select some objects with random confidences
        const numDetections = Math.floor(Math.random() * 5) + 3;
        const classifications = [];
        const detections = [];
        
        for (let i = 0; i < numDetections; i++) {
            const obj = commonObjects[Math.floor(Math.random() * commonObjects.length)];
            const confidence = Math.random() * 0.3 + 0.7; // 0.7 to 1.0
            
            classifications.push({
                className: obj,
                probability: confidence
            });
            
            detections.push({
                class: obj,
                score: confidence,
                bbox: [Math.random() * width * 0.3, Math.random() * height * 0.3, width * 0.4, height * 0.4]
            });
        }
        
        return [classifications, detections];
    }

    function processAIDetections(classifications, detections) {
        const allDetections = [];
        
        // Add classifications
        if (classifications && classifications.length > 0) {
            classifications.forEach(prediction => {
                if (prediction.probability > 0.2) { // Only include confident predictions
                    allDetections.push({
                        label: prediction.className || prediction.class,
                        confidence: Math.round((prediction.probability || prediction.score) * 100),
                        type: 'classification',
                        source: aiModelsLoaded ? 'MobileNet' : 'Simulated AI'
                    });
                }
            });
        }

        // Add object detections
        if (detections && detections.length > 0) {
            detections.forEach(detection => {
                if (detection.score > 0.3) {
                    allDetections.push({
                        label: detection.class,
                        confidence: Math.round(detection.score * 100),
                        type: 'object',
                        source: aiModelsLoaded ? 'COCO-SSD' : 'Simulated AI',
                        bbox: detection.bbox
                    });
                }
            });
        }

        // Remove duplicates and sort by confidence
        const uniqueDetections = [];
        const seenLabels = new Set();
        
        const sortedDetections = allDetections.sort((a, b) => b.confidence - a.confidence);
        
        sortedDetections.forEach(detection => {
            const cleanLabel = detection.label.toLowerCase().split(',')[0].trim();
            if (!seenLabels.has(cleanLabel) && cleanLabel.length > 2) {
                seenLabels.add(cleanLabel);
                uniqueDetections.push({
                    ...detection,
                    cleanLabel: cleanLabel
                });
            }
        });

        return uniqueDetections.slice(0, 8); // Return top 8
    }

    function displayDetectionResults(detections) {
        const detectionList = document.getElementById('detectionList');
        
        if (!detections || detections.length === 0) {
            detectionList.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
                    <p>No objects detected with confidence</p>
                    ${!aiModelsLoaded ? '<p style="color: var(--warning); font-size: 0.9rem;"><i class="fas fa-exclamation-triangle"></i> Using simulated detection</p>' : ''}
                </div>
            `;
        } else {
            detectionList.innerHTML = detections.map(detection => `
                <div class="detection-item">
                    <div class="detection-label">
                        <i class="fas fa-${detection.type === 'classification' ? 'tag' : 'cube'}"></i>
                        ${detection.label}
                        <small style="color: var(--gray); font-size: 0.8rem; display: block;">
                            ${detection.source}
                            ${detection.confidence < 60 ? ' (Low confidence)' : ''}
                        </small>
                    </div>
                    <div class="detection-confidence">
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${detection.confidence}%"></div>
                        </div>
                        <span class="confidence-value">${detection.confidence}%</span>
                    </div>
                </div>
            `).join('');
            
            if (!aiModelsLoaded) {
                detectionList.innerHTML += `
                    <div style="text-align: center; padding: 15px; background: var(--warning); color: #856404; border-radius: 10px; margin-top: 15px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Using simulated AI detection. For real AI, ensure TensorFlow.js loads properly.
                    </div>
                `;
            }
        }
        
        document.getElementById('detectionResults').classList.add('active');
        
        // Scroll to results
        document.getElementById('detectionResults').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }

    // ========== PRODUCT MATCHING ==========
    async function findSimilarProducts() {
        if (!aiDetections || aiDetections.length === 0) {
            showToast('Please analyze an image first', 'warning');
            return;
        }

        // Disable search button during processing
        const searchBtn = document.getElementById('searchBtn');
        const originalText = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        searchBtn.disabled = true;

        document.getElementById('loadingSection').classList.add('active');
        updateLoading("Finding Similar Products", "Matching with database...");

        // Simulate search delay for better UX
        await new Promise(resolve => setTimeout(resolve, 800));

        const primaryDetection = aiDetections[0];
        const searchTerms = aiDetections.map(d => d.cleanLabel);

        // Find matching products
        const matchingProducts = productDatabase.map(product => {
            let matchScore = 0;
            let matchedTerms = [];

            // Check each search term against product
            searchTerms.forEach(term => {
                // Check in AI tags
                product.aiTags.forEach(tag => {
                    const tagLower = tag.toLowerCase();
                    const termLower = term.toLowerCase();
                    
                    if (tagLower.includes(termLower) || termLower.includes(tagLower)) {
                        matchScore += 35;
                        if (!matchedTerms.includes(tag)) {
                            matchedTerms.push(tag);
                        }
                    }
                });

                // Check in name
                if (product.name.toLowerCase().includes(term.toLowerCase())) {
                    matchScore += 30;
                }

                // Check in category
                if (product.category.toLowerCase().includes(term.toLowerCase())) {
                    matchScore += 25;
                }
                
                if (product.subCategory.toLowerCase().includes(term.toLowerCase())) {
                    matchScore += 20;
                }
            });

            // Base similarity + weighted match score
            const similarity = Math.min(40 + (matchScore / 2), 100);

            return {
                ...product,
                similarity: Math.round(similarity),
                matchedTerms: matchedTerms.slice(0, 3),
                matchScore: matchScore
            };
        })
        .filter(product => product.similarity >= 40) // Lower threshold for more results
        .sort((a, b) => b.similarity - a.similarity)
        .slice(0, 8); // Limit to 8 products

        document.getElementById('loadingSection').classList.remove('active');

        if (matchingProducts.length > 0) {
            document.getElementById('resultsSection').classList.add('active');
            document.getElementById('noResultsSection').classList.remove('active');
            displaySearchResults(matchingProducts, primaryDetection);
            showToast(`Found ${matchingProducts.length} matching products!`, 'success');
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        } else {
            document.getElementById('noResultsSection').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
            showToast('No matching products found', 'warning');
        }
        
        // Re-enable search button
        searchBtn.innerHTML = originalText;
        searchBtn.disabled = false;
    }

    // ========== DISPLAY RESULTS ==========
    function displaySearchResults(results, primaryDetection) {
        const resultsSection = document.getElementById('resultsSection');
        
        resultsSection.innerHTML = `
            <div class="results-header">
                <h2><i class="fas fa-robot"></i> ${aiModelsLoaded ? 'AI-Powered' : 'Simulated'} Search Results</h2>
                <p>Based on detection: "${primaryDetection.label}" (${primaryDetection.confidence}% confidence)</p>
                ${!aiModelsLoaded ? 
                    '<p style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Using simulated detection - results may vary</p>' : 
                    ''}
            </div>
            
            <div class="match-details">
                <h3>Analysis Summary</h3>
                <div class="match-stats">
                    <div class="stat-item">
                        <div class="stat-value">${aiDetections.length}</div>
                        <div class="stat-label">Objects Detected</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${results.length}</div>
                        <div class="stat-label">Products Found</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${results[0]?.similarity || 0}%</div>
                        <div class="stat-label">Best Match</div>
                    </div>
                </div>
            </div>
            
            <div class="products-grid">
                ${results.map(product => `
                    <div class="product-card">
                        <div class="product-badge" style="background: ${getSimilarityColor(product.similarity)}">
                            ${product.similarity}% Match
                        </div>
                        <div class="product-image">
                            <img src="${product.image}" alt="${product.name}" 
                                 onerror="this.src='https://via.placeholder.com/500x400?text=Product+Image'">
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <p>${product.category} • ${product.subCategory}</p>
                            ${product.matchedTerms && product.matchedTerms.length > 0 ? `
                            <div style="margin: 10px 0;">
                                <small style="color: var(--success);">
                                    <i class="fas fa-robot"></i> AI Matched: 
                                    ${product.matchedTerms.join(', ')}
                                </small>
                            </div>
                            ` : ''}
                            <div class="similarity-score" style="background: ${getSimilarityColor(product.similarity)}">
                                <i class="fas fa-brain"></i> ${product.similarity}% AI Match
                            </div>
                            <div class="product-price">
                                $${product.price.toFixed(2)}
                                ${product.oldPrice ? `<span class="old-price">$${product.oldPrice.toFixed(2)}</span>` : ''}
                            </div>
                            <div class="product-rating">
                                <div class="stars">${generateStars(product.rating)}</div>
                                <span class="rating-count">${product.rating.toFixed(1)} (${product.reviews.toLocaleString()} reviews)</span>
                            </div>
                            <button class="add-to-cart" onclick="addToCart(${product.id}, '${product.name}', ${product.price}, this)">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // ========== UTILITY FUNCTIONS ==========
    function showUploadProgress() {
        document.getElementById('uploadProgress').style.display = 'block';
        document.getElementById('progressText').textContent = 'Uploading...';
        document.getElementById('progressFill').style.width = '0%';
    }

    function hideUploadProgress() {
        document.getElementById('uploadProgress').style.display = 'none';
    }

    function simulateProgress(callback) {
        let progress = 0;
        const progressBar = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        const interval = setInterval(() => {
            progress += 10;
            progressBar.style.width = progress + '%';
            progressText.textContent = `Uploading... ${progress}%`;
            
            if (progress >= 100) {
                clearInterval(interval);
                if (callback) callback();
            }
        }, 100);
    }

    function updateAIStatus(text, status) {
        const aiStatus = document.getElementById('aiStatus');
        const aiStatusText = document.getElementById('aiStatusText');
        
        aiStatusText.textContent = text;
        aiStatus.className = 'ai-status ' + status;
    }

    function updateLoading(title, message) {
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('loadingMessage').textContent = message;
    }

    function getSimilarityColor(score) {
        if (score >= 90) return '#28a745';
        if (score >= 80) return '#20c997';
        if (score >= 70) return '#17a2b8';
        if (score >= 60) return '#ffc107';
        if (score >= 50) return '#fd7e14';
        return '#6c757d';
    }

    function generateStars(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        
        let stars = '';
        for (let i = 0; i < fullStars; i++) stars += '<i class="fas fa-star"></i>';
        if (halfStar) stars += '<i class="fas fa-star-half-alt"></i>';
        for (let i = 0; i < emptyStars; i++) stars += '<i class="far fa-star"></i>';
        
        return stars;
    }

    function addToCart(productId, productName, price, button) {
        if (button.disabled) return;
        
        button.innerHTML = '<i class="fas fa-check"></i> Added to Cart';
        button.classList.add('added');
        button.disabled = true;
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        // Check if product already in cart
        const existingIndex = cart.findIndex(item => item.id === productId);
        if (existingIndex > -1) {
            cart[existingIndex].quantity += 1;
        } else {
            cart.push({ 
                id: productId, 
                name: productName, 
                price: price, 
                quantity: 1,
                image: productDatabase.find(p => p.id === productId)?.image || ''
            });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        
        showToast(`${productName} added to cart!`, 'success');
        
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
            button.classList.remove('added');
            button.disabled = false;
        }, 3000);
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast';
        
        if (type === 'error') toast.classList.add('error');
        else if (type === 'warning') toast.classList.add('warning');
        else if (type === 'info') toast.classList.add('info');
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // ========== CAMERA FUNCTIONS ==========
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            const cameraView = document.getElementById('cameraView');
            cameraView.srcObject = stream;
            cameraView.classList.add('active');
            document.getElementById('cameraSection').classList.add('active');
            currentStream = stream;
            showToast('Camera ready! Click "Capture Photo"', 'success');
        } catch (err) {
            console.error("Camera error:", err);
            showToast('Camera error: ' + err.message, 'error');
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            document.getElementById('cameraView').classList.remove('active');
            document.getElementById('cameraSection').classList.remove('active');
            currentStream = null;
        }
    }

    function capturePhoto() {
        const cameraView = document.getElementById('cameraView');
        const canvas = document.getElementById('photoCanvas');
        const context = canvas.getContext('2d');

        canvas.width = cameraView.videoWidth;
        canvas.height = cameraView.videoHeight;
        context.drawImage(cameraView, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL('image/png');
        document.getElementById('previewImage').src = imageData;
        document.getElementById('imagePreview').classList.add('active');
        document.getElementById('cameraSection').classList.remove('active');
        selectedImage = imageData;
        
        stopCamera();
        showToast('Photo captured! Click "Analyze with AI"', 'success');
        
        // Reset detection results
        document.getElementById('detectionResults').classList.remove('active');
        document.getElementById('resultsSection').classList.remove('active');
    }

    function showUrlInput() {
        document.getElementById('urlInputSection').classList.add('active');
        document.getElementById('imagePreview').classList.remove('active');
    }

    function hideUrlInput() {
        document.getElementById('urlInputSection').classList.remove('active');
    }

    function loadImageFromUrl() {
        const url = document.getElementById('imageUrl').value.trim();
        if (url) {
            if (!url.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i)) {
                showToast('Please enter a valid image URL (jpg, png, gif, webp)', 'error');
                return;
            }
            
            showUploadProgress();
            simulateProgress(() => {
                const img = new Image();
                img.onload = function() {
                    document.getElementById('previewImage').src = url;
                    document.getElementById('imagePreview').classList.add('active');
                    document.getElementById('urlInputSection').classList.remove('active');
                    selectedImage = url;
                    
                    // Reset detection results
                    document.getElementById('detectionResults').classList.remove('active');
                    document.getElementById('resultsSection').classList.remove('active');
                    
                    showToast('Image loaded! Click "Analyze with AI"', 'success');
                    hideUploadProgress();
                };
                img.onerror = function() {
                    showToast('Failed to load image from URL. Please check the link.', 'error');
                    hideUploadProgress();
                };
                img.src = url;
            });
        } else {
            showToast('Please enter a valid URL', 'error');
        }
    }

    function clearImage() {
        document.getElementById('previewImage').src = '';
        document.getElementById('imagePreview').classList.remove('active');
        document.getElementById('fileUpload').value = '';
        document.getElementById('imageUrl').value = '';
        document.getElementById('noResultsSection').classList.remove('active');
        document.getElementById('resultsSection').classList.remove('active');
        document.getElementById('detectionResults').classList.remove('active');
        document.getElementById('urlInputSection').classList.remove('active');
        selectedImage = null;
        aiDetections = [];
        
        // Reset buttons
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('searchBtn').disabled = true;
        
        showToast('Image cleared. Upload a new image to search.', 'info');
    }

    // ========== KEYBOARD SHORTCUTS ==========
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentStream) {
            stopCamera();
        }
        
        if (e.key === 'Enter' && document.getElementById('urlInputSection').classList.contains('active')) {
            loadImageFromUrl();
        }
        
        if (e.key === ' ' && selectedImage && document.getElementById('imagePreview').classList.contains('active')) {
            runAIanalysis();
        }
    });
</script>
{% endblock %}