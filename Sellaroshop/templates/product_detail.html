<!-- templates/product_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Product Images -->
        <div class="col-md-6">
            <div class="product-images">
                {% if product.image %}
                <img src="{{ product.image.url }}" class="img-fluid rounded mb-3" alt="{{ product.name }}" id="mainImage">
                {% else %}
                <img src="{% static 'img/default-product.jpg' %}" class="img-fluid rounded mb-3" alt="{{ product.name }}" id="mainImage">
                {% endif %}
                
                {% if images %}
                <div class="row">
                    {% for image in images %}
                    <div class="col-3">
                        <img src="{{ image.image.url }}" class="img-thumbnail" alt="{{ product.name }}" 
                             style="cursor: pointer; height: 80px; object-fit: cover;" 
                             onclick="document.getElementById('mainImage').src = this.src">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <div class="product-info">
                {% if product.is_on_sale %}
                <span class="badge bg-danger mb-2">SALE</span>
                {% endif %}
                {% if product.is_new %}
                <span class="badge bg-success mb-2">NEW</span>
                {% endif %}
                
                <h1 class="product-title">{{ product.name }}</h1>
                
                <div class="rating mb-3">
                    <span class="text-warning">
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.rating %}
                            <i class="fas fa-star"></i>
                            {% else %}
                            <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </span>
                    <span class="ms-2">({{ product.review_count }} reviews)</span>
                </div>
                
                <div class="price mb-4">
                    {% if product.is_on_sale %}
                    <h2 class="text-danger">${{ product.final_price }}</h2>
                    <h4 class="text-muted text-decoration-line-through">${{ product.price }}</h4>
                    <span class="badge bg-danger">Save {{ product.discount_percentage }}%</span>
                    {% else %}
                    <h2>${{ product.final_price }}</h2>
                    {% endif %}
                </div>
                
                <div class="stock mb-4">
                    {% if product.is_in_stock %}
                    <span class="text-success"><i class="fas fa-check-circle"></i> In Stock ({{ product.stock }} available)</span>
                    {% else %}
                    <span class="text-danger"><i class="fas fa-times-circle"></i> Out of Stock</span>
                    {% endif %}
                </div>
                
                <div class="description mb-4">
                    <h5>Description</h5>
                    <p>{{ product.description|linebreaks }}</p>
                </div>
                
                <div class="product-meta mb-4">
                    <p><strong>Category:</strong> <a href="{% url 'category_products' product.category.slug %}">{{ product.category.name }}</a></p>
                    {% if product.brand %}
                    <p><strong>Brand:</strong> <a href="{% url 'brand_products' product.brand.slug %}">{{ product.brand.name }}</a></p>
                    {% endif %}
                </div>
                
                <div class="actions">
                    {% if product.is_in_stock %}
                    <div class="d-flex gap-3">
                        <button onclick="addToCart({{ product.id }})" class="btn btn-primary btn-lg flex-grow-1">
                            <i class="fas fa-cart-plus"></i> Add to Cart
                        </button>
                        
                        {% if in_wishlist %}
                        <button onclick="toggleWishlist({{ product.id }})" class="btn btn-outline-danger">
                            <i class="fas fa-heart"></i>
                        </button>
                        {% else %}
                        <button onclick="toggleWishlist({{ product.id }})" class="btn btn-outline-secondary">
                            <i class="far fa-heart"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% else %}
                    <button class="btn btn-secondary btn-lg w-100" disabled>Out of Stock</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-5">
        <h3>Related Products</h3>
        <div class="row">
            {% for product in related_products %}
            <div class="col-md-3 col-sm-6 mb-4">
                <div class="card h-100 product-card">
                    <div class="position-relative">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}" style="height: 150px; object-fit: cover;">
                        {% else %}
                        <img src="{% static 'img/default-product.jpg' %}" class="card-img-top" alt="{{ product.name }}" style="height: 150px; object-fit: cover;">
                        {% endif %}
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">{{ product.name|truncatechars:25 }}</h6>
                        <p class="card-text fw-bold">${{ product.final_price }}</p>
                        <div class="mt-auto">
                            <button onclick="addToCart({{ product.id }})" class="btn btn-primary btn-sm w-100">
                                <i class="fas fa-cart-plus"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Reviews -->
    {% if reviews %}
    <div class="mt-5">
        <h3>Customer Reviews</h3>
        {% for review in reviews %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h6 class="card-title">{{ review.user.username }}</h6>
                    <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                </div>
                <div class="rating mb-2">
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                        <i class="fas fa-star text-warning"></i>
                        {% else %}
                        <i class="far fa-star text-warning"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <p class="card-text">{{ review.comment }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
function toggleWishlist(productId) {
    const formData = new FormData();
    formData.append('product_id', productId);
    
    fetch("{% url 'toggle_wishlist' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message);
            location.reload();
        }
    });
}
</script>
{% endblock %}