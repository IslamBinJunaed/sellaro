{% extends 'base.html' %}
{% load static %}

{% block title %}Nearby Stores - Sellaro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
    /* Reset & variables */
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }

    :root {
        --primary: #3a86ff;
        --secondary: #8338ec;
        --accent: #ff006e;
        --samsung-blue: #1428a0;
        --samsung-light: #2c5dff;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --shadow: 0 5px 15px rgba(0,0,0,0.1);
        --shadow-hover: 0 10px 30px rgba(0,0,0,0.15);
        --transition: all 0.3s ease;
    }

    body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: var(--dark);
        line-height: 1.6;
        min-height: 100vh;
    }

    .container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* Back button */
    .back-button { 
        display: inline-flex; 
        align-items: center; 
        gap: 10px; 
        background: linear-gradient(135deg, var(--samsung-blue), var(--samsung-light)); 
        color: white; 
        padding: 14px 28px; 
        border-radius: 30px; 
        text-decoration: none; 
        transition: var(--transition); 
        border: 2px solid transparent; 
        font-weight: 600; 
        margin: 20px 0; 
        box-shadow: var(--shadow);
    }
    .back-button:hover { 
        background: white; 
        color: var(--samsung-blue); 
        border-color: var(--samsung-blue); 
        transform: translateY(-3px) scale(1.02);
        box-shadow: var(--shadow-hover); 
    }

    /* Hero Section */
    .samsung-hero { 
        background: linear-gradient(135deg, var(--samsung-blue) 0%, var(--samsung-light) 50%, var(--primary) 100%);
        color: white; 
        padding: 100px 0 80px;
        text-align: center; 
        margin-bottom: 40px; 
        position: relative;
        overflow: hidden;
    }
    
    .samsung-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        opacity: 0.3;
    }
    
    .samsung-hero-content { 
        max-width: 800px; 
        margin: 0 auto; 
        position: relative;
        z-index: 1;
    }
    .samsung-logo { 
        font-size: 5rem; 
        margin-bottom: 25px; 
        color: white; 
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .samsung-hero h1 { 
        font-size: 4rem; 
        margin-bottom: 25px; 
        text-shadow: 2px 2px 8px rgba(0,0,0,0.3); 
        background: linear-gradient(45deg, white, #ffd6e7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: fadeInDown 0.8s ease;
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .samsung-hero p { 
        font-size: 1.4rem; 
        margin-bottom: 50px; 
        opacity: 0.95; 
        animation: fadeInUp 0.8s ease 0.2s both;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .cta-buttons { 
        display: flex; 
        justify-content: center; 
        gap: 25px; 
        flex-wrap: wrap; 
    }
    .btn { 
        padding: 18px 40px; 
        border: none; 
        border-radius: 30px; 
        font-size: 1.2rem; 
        font-weight: 700; 
        cursor: pointer; 
        transition: var(--transition); 
        display: inline-flex; 
        align-items: center; 
        gap: 12px; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }
    
    .btn:hover::before {
        left: 100%;
    }
    
    .btn-primary { 
        background: linear-gradient(135deg, var(--accent), #ff4d94); 
        color: white; 
    }
    .btn-primary:hover { 
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 10px 30px rgba(255,0,110,0.4); 
    }
    .btn-secondary { 
        background: transparent; 
        color: white; 
        border: 3px solid white;
        backdrop-filter: blur(10px);
    }
    .btn-secondary:hover { 
        background: white; 
        color: var(--dark); 
        transform: translateY(-5px) scale(1.05);
    }

    /* Map Section */
    .map-section {
        padding: 60px 0;
        animation: fadeIn 0.8s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    #map { 
        width: 100%; 
        height: 550px; 
        border-radius: 20px; 
        box-shadow: var(--shadow-hover); 
        margin-bottom: 40px;
        border: 3px solid white;
        z-index: 1;
    }

    /* Map Controls */
    .map-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }
    .map-btn {
        padding: 12px 25px;
        background: linear-gradient(135deg, var(--samsung-blue), var(--samsung-light));
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(20, 40, 160, 0.3);
    }
    
    .map-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }
    
    .map-btn:hover::before {
        left: 100%;
    }
    
    .map-btn:hover {
        background: linear-gradient(135deg, var(--samsung-light), var(--primary));
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(20, 40, 160, 0.4);
    }
    .map-btn.naver {
        background: linear-gradient(135deg, #03c75a, #02b350);
    }
    .map-btn.naver:hover {
        background: linear-gradient(135deg, #02b350, #019e45);
        box-shadow: 0 8px 25px rgba(3, 199, 90, 0.4);
    }
    .map-btn.kakao {
        background: linear-gradient(135deg, #fee500, #fada0a);
        color: #3c1e1e;
    }
    .map-btn.kakao:hover {
        background: linear-gradient(135deg, #fada0a, #e6c900);
        box-shadow: 0 8px 25px rgba(254, 229, 0, 0.4);
    }
    .map-btn.route {
        background: linear-gradient(135deg, var(--accent), #ff4d94);
    }
    .map-btn.route:hover {
        background: linear-gradient(135deg, #ff4d94, #ff3380);
        box-shadow: 0 8px 25px rgba(255, 0, 110, 0.4);
    }

    /* Route Information Panel */
    .route-info-panel {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--shadow-hover);
        margin-top: 25px;
        animation: slideInUp 0.5s ease;
        border: 2px solid var(--light);
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(40px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .route-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 3px solid var(--light);
    }

    .route-header h3 {
        font-size: 1.5rem;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .close-route-btn {
        background: var(--light);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        font-size: 1.2rem;
    }

    .close-route-btn:hover {
        background: var(--danger);
        color: white;
        transform: rotate(90deg);
    }

    .route-details {
        text-align: center;
    }

    .route-loading {
        padding: 30px;
        color: var(--gray);
        font-size: 1.1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .route-loading .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--light);
        border-top: 5px solid var(--primary);
        border-right: 5px solid var(--secondary);
        border-bottom: 5px solid var(--accent);
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .route-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .route-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 20px;
        background: var(--light);
        border-radius: 15px;
        min-width: 140px;
        transition: var(--transition);
    }

    .route-stat:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow);
    }

    .route-stat i {
        font-size: 2rem;
        color: var(--primary);
    }

    .route-stat span {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--dark);
    }

    .route-stat .label {
        font-size: 0.9rem;
        color: var(--gray);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .route-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .route-action-btn {
        padding: 14px 25px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: var(--transition);
        min-width: 160px;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .route-action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }

    .route-action-btn:hover::before {
        left: 100%;
    }

    .route-action-btn.naver {
        background: linear-gradient(135deg, #03c75a, #02b350);
        color: white;
        box-shadow: 0 4px 15px rgba(3, 199, 90, 0.3);
    }

    .route-action-btn.naver:hover {
        background: linear-gradient(135deg, #02b350, #019e45);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(3, 199, 90, 0.4);
    }

    .route-action-btn.kakao {
        background: linear-gradient(135deg, #fee500, #fada0a);
        color: #3c1e1e;
        box-shadow: 0 4px 15px rgba(254, 229, 0, 0.3);
    }

    .route-action-btn.kakao:hover {
        background: linear-gradient(135deg, #fada0a, #e6c900);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(254, 229, 0, 0.4);
    }

    .route-action-btn.google {
        background: linear-gradient(135deg, #4285f4, #3367d6);
        color: white;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
    }

    .route-action-btn.google:hover {
        background: linear-gradient(135deg, #3367d6, #2a56c4);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
    }

    .route-action-btn.map {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
    }

    .route-action-btn.map:hover {
        background: linear-gradient(135deg, var(--secondary), var(--accent));
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(58, 134, 255, 0.4);
    }

    /* Stores Section */
    .stores-section { 
        padding: 100px 0; 
        background: white;
        border-radius: 30px 30px 0 0;
        margin-top: -30px;
        position: relative;
        z-index: 2;
    }
    
    .stores-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 30px;
        background: linear-gradient(to bottom, transparent, white);
    }
    
    .stores-controls { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 50px; 
        flex-wrap: wrap; 
        gap: 25px; 
    }
    .stores-filter { 
        display: flex; 
        gap: 15px; 
        flex-wrap: wrap; 
    }
    .filter-btn { 
        padding: 12px 28px; 
        border: 2px solid var(--samsung-blue); 
        background: transparent; 
        color: var(--samsung-blue); 
        border-radius: 30px; 
        cursor: pointer; 
        transition: var(--transition); 
        font-weight: 700; 
        font-size: 1rem;
        position: relative;
        overflow: hidden;
    }
    
    .filter-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(20, 40, 160, 0.1), transparent);
        transition: 0.5s;
    }
    
    .filter-btn:hover::before {
        left: 100%;
    }
    
    .filter-btn.active, .filter-btn:hover { 
        background: linear-gradient(135deg, var(--samsung-blue), var(--samsung-light)); 
        color: white; 
        border-color: transparent;
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(20, 40, 160, 0.3);
    }
    
    .search-stores { 
        position: relative; 
        min-width: 350px;
    }
    
    .search-stores input { 
        width: 100%; 
        padding: 15px 25px; 
        border: 2px solid #e9ecef; 
        border-radius: 30px; 
        font-size: 1.1rem; 
        transition: var(--transition); 
        background: var(--light);
    }
    
    .search-stores input:focus { 
        border-color: var(--samsung-blue); 
        outline: none;
        box-shadow: 0 0 0 4px rgba(20, 40, 160, 0.1);
        background: white;
    }

    .stores-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); 
        gap: 35px; 
    }
    .store-card { 
        background: white; 
        border-radius: 20px; 
        padding: 35px; 
        box-shadow: var(--shadow); 
        transition: var(--transition); 
        border: 2px solid transparent;
        position: relative; 
        overflow: hidden;
        animation: fadeInUp 0.5s ease;
        animation-fill-mode: both;
    }
    
    .store-card:nth-child(1) { animation-delay: 0.1s; }
    .store-card:nth-child(2) { animation-delay: 0.2s; }
    .store-card:nth-child(3) { animation-delay: 0.3s; }
    .store-card:nth-child(4) { animation-delay: 0.4s; }
    .store-card:nth-child(5) { animation-delay: 0.5s; }
    .store-card:nth-child(6) { animation-delay: 0.6s; }
    
    .store-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--samsung-blue), var(--samsung-light), var(--primary));
        transform: scaleX(0);
        transition: var(--transition);
        transform-origin: left;
    }
    
    .store-card:hover::before {
        transform: scaleX(1);
    }
    
    .store-card:hover { 
        transform: translateY(-10px) scale(1.02);
        box-shadow: var(--shadow-hover); 
        border-color: var(--samsung-blue);
    }
    
    .store-badge { 
        position: absolute; 
        top: 20px; 
        right: 20px; 
        background: linear-gradient(135deg, var(--accent), #ff4d94);
        color: white; 
        padding: 8px 20px; 
        border-radius: 25px; 
        font-size: 0.85rem; 
        font-weight: 700; 
        z-index: 2; 
        box-shadow: 0 4px 15px rgba(255, 0, 110, 0.3);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .store-header {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 25px;
    }
    .store-icon {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, var(--samsung-blue), var(--samsung-light));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.8rem;
        flex-shrink: 0;
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(20, 40, 160, 0.3);
    }
    
    .store-card:hover .store-icon {
        transform: rotate(15deg) scale(1.1);
    }
    
    .store-info h3 {
        font-size: 1.5rem;
        margin-bottom: 12px;
        color: var(--dark);
        font-weight: 700;
        line-height: 1.4;
    }
    .store-type {
        color: var(--samsung-blue);
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 1.1rem;
    }
    .store-rating {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    .store-rating .stars {
        color: var(--warning);
        font-size: 1.1rem;
    }
    .store-rating span {
        color: var(--gray);
        font-weight: 600;
        font-size: 1rem;
    }
    .store-details {
        margin-bottom: 30px;
    }
    .store-address {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 15px;
        color: var(--gray);
        cursor: pointer;
        transition: var(--transition);
        padding: 10px;
        border-radius: 10px;
        background: var(--light);
    }
    .store-address:hover {
        color: var(--samsung-blue);
        background: rgba(20, 40, 160, 0.05);
        transform: translateX(5px);
    }
    .store-address i {
        color: var(--samsung-blue);
        margin-top: 2px;
        font-size: 1.2rem;
    }
    .store-hours {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--gray);
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
        background: var(--light);
    }
    .store-hours i {
        color: var(--success);
        font-size: 1.2rem;
    }
    .store-phone {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--gray);
        padding: 10px;
        border-radius: 10px;
        background: var(--light);
    }
    .store-phone i {
        color: var(--primary);
        font-size: 1.2rem;
    }
    .store-features {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 25px;
    }
    .store-feature {
        background: linear-gradient(135deg, var(--light), #e9ecef);
        color: var(--dark);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .store-feature:hover {
        background: linear-gradient(135deg, var(--samsung-blue), var(--samsung-light));
        color: white;
        transform: translateY(-2px);
    }
    
    .store-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    .store-btn {
        flex: 1;
        padding: 14px 20px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.95rem;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }
    
    .store-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }
    
    .store-btn:hover::before {
        left: 100%;
    }
    
    .store-btn.primary {
        background: linear-gradient(135deg, var(--samsung-blue), var(--samsung-light));
        color: white;
        box-shadow: 0 4px 15px rgba(20, 40, 160, 0.3);
    }
    .store-btn.primary:hover {
        background: linear-gradient(135deg, var(--samsung-light), var(--primary));
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(20, 40, 160, 0.4);
    }
    .store-btn.secondary {
        background: transparent;
        color: var(--samsung-blue);
        border: 2px solid var(--samsung-blue);
    }
    .store-btn.secondary:hover {
        background: var(--samsung-blue);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(20, 40, 160, 0.4);
    }
    .store-btn.naver {
        background: linear-gradient(135deg, #03c75a, #02b350);
        color: white;
        box-shadow: 0 4px 15px rgba(3, 199, 90, 0.3);
    }
    .store-btn.naver:hover {
        background: linear-gradient(135deg, #02b350, #019e45);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(3, 199, 90, 0.4);
    }
    .store-btn.kakao {
        background: linear-gradient(135deg, #fee500, #fada0a);
        color: #3c1e1e;
        border: none;
        box-shadow: 0 4px 15px rgba(254, 229, 0, 0.3);
    }
    .store-btn.kakao:hover {
        background: linear-gradient(135deg, #fada0a, #e6c900);
        color: #3c1e1e;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(254, 229, 0, 0.4);
    }

    /* Map Popup Styles */
    .leaflet-popup-content-wrapper {
        border-radius: 15px;
        box-shadow: var(--shadow-hover);
        padding: 0;
        overflow: hidden;
    }
    
    .store-popup {
        min-width: 300px;
        padding: 20px;
    }
    
    .store-popup h3 {
        margin: 0 0 15px 0;
        color: var(--samsung-blue);
        font-size: 1.3rem;
        font-weight: 700;
    }
    
    .store-popup p {
        margin: 0 0 10px 0;
        font-size: 1rem;
        color: var(--gray);
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .store-popup p i {
        color: var(--samsung-blue);
        margin-top: 2px;
    }
    
    .store-popup .store-features {
        margin: 15px 0;
        font-size: 0.9rem;
    }
    
    .store-popup .map-actions {
        display: flex;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .store-popup .map-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
        flex: 1;
        min-width: 120px;
        justify-content: center;
        border-radius: 10px;
    }

    /* Location Info */
    .location-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, var(--light), #e9ecef);
        padding: 20px 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
        box-shadow: var(--shadow);
        animation: fadeIn 0.5s ease;
    }
    
    .location-info div {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .location-info i {
        color: var(--samsung-blue);
        font-size: 1.5rem;
    }
    
    .location-info strong {
        color: var(--dark);
        font-weight: 700;
    }
    
    .location-info span {
        color: var(--gray);
        font-weight: 600;
    }

    /* Toast Notification */
    .toast { 
        position: fixed; 
        bottom: 40px; 
        right: 40px; 
        background: linear-gradient(135deg, var(--success), #20c997); 
        color: white; 
        padding: 20px 30px; 
        border-radius: 12px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        z-index: 9999; 
        transform: translateX(100px); 
        opacity: 0; 
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        max-width: 400px; 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        font-weight: 600;
    }
    
    .toast.show { 
        transform: translateX(0); 
        opacity: 1; 
    }
    
    .toast.error {
        background: linear-gradient(135deg, var(--danger), #e83e8c);
    }
    
    .toast.warning {
        background: linear-gradient(135deg, var(--warning), #fd7e14);
        color: var(--dark);
    }
    
    .toast.info {
        background: linear-gradient(135deg, var(--info), #007bff);
    }
    
    .toast i {
        font-size: 1.5rem;
    }

    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 40px;
        left: 40px;
        background: linear-gradient(135deg, var(--accent), var(--secondary));
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(255, 0, 110, 0.4);
        transition: var(--transition);
        z-index: 1000;
        animation: float 3s ease-in-out infinite;
    }
    
    .fab:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 12px 35px rgba(255, 0, 110, 0.6);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .container {
            padding: 0 30px;
        }
        
        .stores-grid {
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 30px;
        }
    }

    @media (max-width: 992px) {
        .samsung-hero {
            padding: 80px 0 60px;
        }
        
        .samsung-hero h1 {
            font-size: 3rem;
        }
        
        .samsung-hero p {
            font-size: 1.2rem;
        }
        
        .stores-section {
            padding: 80px 0;
        }
        
        .stores-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-stores {
            min-width: 100%;
        }
        
        .route-stats {
            gap: 20px;
        }
        
        .route-stat {
            min-width: 120px;
            padding: 15px;
        }
    }

    @media (max-width: 768px) {
        .samsung-hero {
            padding: 60px 0 40px;
        }

        .samsung-hero h1 {
            font-size: 2.5rem;
        }

        .samsung-hero p {
            font-size: 1.1rem;
        }
        
        .samsung-logo {
            font-size: 4rem;
        }

        .cta-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .btn {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
        
        #map {
            height: 450px;
        }

        .map-controls {
            justify-content: center;
        }
        
        .map-btn {
            flex: 1;
            min-width: 160px;
            justify-content: center;
        }

        .stores-grid {
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .store-card {
            max-width: 450px;
            margin: 0 auto;
        }

        .store-actions {
            flex-direction: column;
        }
        
        .route-actions {
            flex-direction: column;
        }
        
        .route-action-btn {
            width: 100%;
        }

        .fab {
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            font-size: 1.3rem;
        }

        .toast {
            bottom: 20px;
            right: 20px;
            left: 20px;
            max-width: none;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 0 15px;
        }
        
        .samsung-hero {
            padding: 40px 0 30px;
        }
        
        .samsung-hero h1 {
            font-size: 2rem;
        }
        
        .samsung-hero p {
            font-size: 1rem;
        }
        
        .samsung-logo {
            font-size: 3rem;
        }

        .btn {
            padding: 15px 25px;
            font-size: 1rem;
        }

        .store-header {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .store-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .store-badge {
            top: 15px;
            right: 15px;
            padding: 6px 15px;
            font-size: 0.75rem;
        }
        
        .route-stats {
            flex-direction: column;
            align-items: center;
        }
        
        .route-stat {
            width: 100%;
            max-width: 250px;
        }
        
        .location-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}


<!-- Samsung Stores Hero Section -->
<section class="samsung-hero">
    <div class="container">
        <div class="samsung-hero-content">
            <div class="samsung-logo">
                <i class="fab fa-samsung"></i>
            </div>
            <h1>Samsung Stores in South Korea</h1>
            <p>Find official Samsung stores, experience zones, and service centers across South Korea. Discover the latest technology and get expert support.</p>
            <div class="cta-buttons">
                <button class="btn btn-primary" onclick="findNearestStore()">
                    <i class="fas fa-location-crosshairs"></i> Find Nearest Store
                </button>
                <button class="btn btn-secondary" onclick="showAllStores()">
                    <i class="fas fa-list"></i> View All Stores
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="map-section">
    <div class="container">
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-btn" onclick="getCurrentLocation()">
                <i class="fas fa-location-arrow"></i> My Location
            </button>
            <button class="map-btn route" onclick="showRouteToNearestStore()" id="routeBtn">
                <i class="fas fa-route"></i> Show Route
            </button>
            <button class="map-btn naver" onclick="openNaverMapAtCenter()">
                <i class="fas fa-external-link-alt"></i> Naver Map
            </button>
            <button class="map-btn kakao" onclick="openKakaoMapAtCenter()">
                <i class="fas fa-map"></i> Kakao Map
            </button>
        </div>

        <div id="map"></div>

        <!-- Current Location Info -->
        <div class="location-info" id="locationInfo" style="display: none;">
            <div>
                <i class="fas fa-map-pin"></i>
                <div>
                    <strong>Your Location:</strong>
                    <span id="currentLocationText"></span>
                </div>
            </div>
            <div>
                <i class="fas fa-store"></i>
                <div>
                    <strong>Nearby Stores:</strong>
                    <span id="nearbyCount">0</span> found
                </div>
            </div>
        </div>

        <!-- Route Information Panel -->
        <div id="routeInfoPanel"></div>
    </div>
</section>

<!-- Stores Section -->
<section class="stores-section">
    <div class="container">
        <div class="stores-controls">
            <div class="stores-filter">
                <button class="filter-btn active" onclick="filterStores('all')">All Stores</button>
                <button class="filter-btn" onclick="filterStores('flagship')">Flagship</button>
                <button class="filter-btn" onclick="filterStores('experience')">Experience</button>
                <button class="filter-btn" onclick="filterStores('service')">Service</button>
            </div>
            <div class="search-stores">
                <input type="text" placeholder="Search stores by name or location..." onkeyup="searchStores(this.value)" id="storeSearch">
            </div>
        </div>

        <div class="stores-grid" id="storesGrid">
            <!-- Stores will be dynamically loaded -->
        </div>
    </div>
</section>

<!-- Floating Action Button -->
<div class="fab" onclick="scrollToTop()" title="Scroll to top">
    <i class="fas fa-arrow-up"></i>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage"></span>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.min.js"></script>
<script>
    // Samsung store data with detailed information
    const samsungStores = [
        {
            id: 1,
            name: "Samsung Gangnam Flagship",
            type: "flagship",
            region: "seoul",
            rating: 4.9,
            reviews: 2847,
            address: "123 Gangnam-daero, Gangnam-gu, Seoul",
            hours: "10:00 AM - 10:00 PM",
            phone: "+82-2-1234-5678",
            lat: 37.4979,
            lng: 127.0276,
            features: ["Latest Products", "Experience Zone", "Repair Center", "VIP Lounge"],
            badge: "Flagship",
            naverPlaceId: "12545375",
            kakaoPlaceId: "834495281"
        },
        {
            id: 2,
            name: "Samsung Myeongdong Experience Store",
            type: "experience",
            region: "seoul",
            rating: 4.8,
            reviews: 1956,
            address: "456 Myeongdong-gil, Jung-gu, Seoul",
            hours: "9:30 AM - 10:30 PM",
            phone: "+82-2-1234-5679",
            lat: 37.5602,
            lng: 126.986,
            features: ["Hands-on Demo", "Gaming Zone", "Photo Studio", "Tax Free"],
            badge: "Experience",
            naverPlaceId: "12545376",
            kakaoPlaceId: "834495282"
        },
        {
            id: 3,
            name: "Samsung Jamsil Service Center",
            type: "service",
            region: "seoul",
            rating: 4.7,
            reviews: 892,
            address: "789 Olympic-ro, Songpa-gu, Seoul",
            hours: "9:00 AM - 8:00 PM",
            phone: "+82-2-1234-5680",
            lat: 37.5111,
            lng: 127.0982,
            features: ["Quick Repair", "Warranty Service", "Parts Replacement"],
            badge: "Service",
            naverPlaceId: "12545377",
            kakaoPlaceId: "834495283"
        },
        {
            id: 4,
            name: "Samsung Busan Flagship",
            type: "flagship",
            region: "busan",
            rating: 4.8,
            reviews: 1345,
            address: "123 Gwangbok-ro, Jung-gu, Busan",
            hours: "10:00 AM - 9:00 PM",
            phone: "+82-51-1234-5678",
            lat: 35.1017,
            lng: 129.0406,
            features: ["Marine View", "Experience Zone", "Repair Center", "Tourist Services"],
            badge: "Flagship",
            naverPlaceId: "12545378",
            kakaoPlaceId: "834495284"
        },
        {
            id: 5,
            name: "Samsung Haeundae Store",
            type: "experience",
            region: "busan",
            rating: 4.6,
            reviews: 789,
            address: "456 Haeundae-haebyeon-ro, Haeundae-gu, Busan",
            hours: "10:00 AM - 10:00 PM",
            phone: "+82-51-1234-5679",
            lat: 35.1587,
            lng: 129.1604,
            features: ["Beach Front", "Summer Specials", "Waterproof Demo"],
            badge: "Seasonal",
            naverPlaceId: "12545379",
            kakaoPlaceId: "834495285"
        },
        {
            id: 6,
            name: "Samsung COEX Store",
            type: "flagship",
            region: "seoul",
            rating: 4.7,
            reviews: 1567,
            address: "513 Yeongdong-daero, Gangnam-gu, Seoul",
            hours: "10:30 AM - 10:00 PM",
            phone: "+82-2-1234-5681",
            lat: 37.5125,
            lng: 127.0588,
            features: ["Underground Mall", "Tech Events", "Workshops"],
            badge: "Popular",
            naverPlaceId: "12545380",
            kakaoPlaceId: "834495286"
        },
        {
            id: 7,
            name: "Samsung Hongdae Store",
            type: "experience",
            region: "seoul",
            rating: 4.5,
            reviews: 945,
            address: "161 Yanghwa-ro, Mapo-gu, Seoul",
            hours: "10:00 AM - 11:00 PM",
            phone: "+82-2-1234-5682",
            lat: 37.5566,
            lng: 126.9223,
            features: ["Youth Oriented", "Live Demos", "Student Discount"],
            badge: "Youth",
            naverPlaceId: "12545381",
            kakaoPlaceId: "834495287"
        },
        {
            id: 8,
            name: "Samsung Incheon Airport Store",
            type: "flagship",
            region: "incheon",
            rating: 4.4,
            reviews: 2345,
            address: "Incheon International Airport Terminal 2",
            hours: "24 Hours",
            phone: "+82-32-1234-5678",
            lat: 37.4479,
            lng: 126.4528,
            features: ["Duty Free", "Traveler Services", "Multilingual Staff"],
            badge: "Airport",
            naverPlaceId: "12545382",
            kakaoPlaceId: "834495288"
        }
    ];

    // Global variables
    let map;
    let markers = [];
    let userLocation = null;
    let userMarker = null;
    let currentFilter = 'all';
    let currentStores = [...samsungStores];
    let routingControl = null;
    let currentRouteStore = null;
    let geocoder = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        loadStores();
        setupGeocoder();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('storeSearch').focus();
            }
            if (e.key === 'Escape') {
                clearRoute();
            }
        });
    });

    // Initialize Leaflet map with routing
    function initMap() {
        map = L.map('map').setView([36.5, 127.5], 7);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Add scale control
        L.control.scale({imperial: false}).addTo(map);
        
        // Initialize routing control (hidden by default)
        routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: false,
            showAlternatives: false,
            lineOptions: {
                styles: [
                    {color: '#3a86ff', opacity: 0.8, weight: 6},
                    {color: '#ffffff', opacity: 1, weight: 2}
                ]
            },
            createMarker: function(i, waypoint, n) {
                if (i === 0) {
                    return L.marker(waypoint.latLng, {
                        icon: L.divIcon({
                            html: '<div class="route-marker start-marker"><i class="fas fa-user"></i></div>',
                            className: 'route-start-marker',
                            iconSize: [45, 45],
                            iconAnchor: [22.5, 45]
                        })
                    });
                } else {
                    return L.marker(waypoint.latLng, {
                        icon: L.divIcon({
                            html: '<div class="route-marker end-marker"><i class="fas fa-store"></i></div>',
                            className: 'route-end-marker',
                            iconSize: [45, 45],
                            iconAnchor: [22.5, 45]
                        })
                    });
                }
            },
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            })
        }).addTo(map);
        
        // Hide routing control initially
        routingControl.hide();
        
        // Listen for route events
        routingControl.on('routesfound', function(e) {
            const routes = e.routes;
            const summary = routes[0].summary;
            
            if (summary && currentRouteStore) {
                showRouteInfo(summary.totalDistance, summary.totalTime);
            }
        });
        
        routingControl.on('routingerror', function(e) {
            console.error('Routing error:', e.error);
            showToast('Could not calculate route. Try external maps.', 'error');
        });
    }

    // Setup geocoder for address search
    function setupGeocoder() {
        geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            position: 'topleft',
            placeholder: 'Search for location...',
            errorMessage: 'Location not found.'
        }).addTo(map);
        
        geocoder.on('markgeocode', function(e) {
            const center = e.geocode.center;
            map.setView(center, 15);
            
            L.marker(center).addTo(map)
                .bindPopup(e.geocode.name)
                .openPopup();
        });
    }

    // WGS84 to TM128 conversion for Naver Maps
    function wgs84ToTm128(lat, lng) {
        const RE = 6371.00877;
        const GRID = 5.0;
        const SLAT1 = 30.0;
        const SLAT2 = 60.0;
        const OLON = 126.0;
        const OLAT = 38.0;
        const XO = 43;
        const YO = 136;
        
        const DEGRAD = Math.PI / 180.0;
        const RADDEG = 180.0 / Math.PI;
        
        const re = RE / GRID;
        const slat1 = SLAT1 * DEGRAD;
        const slat2 = SLAT2 * DEGRAD;
        const olon = OLON * DEGRAD;
        const olat = OLAT * DEGRAD;
        
        let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        let sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        let ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);
        
        let ra = Math.tan(Math.PI * 0.25 + lat * DEGRAD * 0.5);
        ra = re * sf / Math.pow(ra, sn);
        let theta = lng * DEGRAD - olon;
        if (theta > Math.PI) theta -= 2.0 * Math.PI;
        if (theta < -Math.PI) theta += 2.0 * Math.PI;
        theta *= sn;
        
        const x = Math.floor(ra * Math.sin(theta) + XO + 0.5);
        const y = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
        
        return { x, y };
    }

    // Generate Naver Map URL with directions
    function generateNaverMapUrl(startLat, startLng, endLat, endLng, storeName = '', placeId = '') {
        const startTm = wgs84ToTm128(startLat, startLng);
        const endTm = wgs84ToTm128(endLat, endLng);
        
        if (placeId) {
            return `https://map.naver.com/v5/directions/${startTm.x},${startTm.y},${placeId},${endTm.x},${endTm.y}/car?c=${startTm.y},${startTm.x},15,0,0,0,dh`;
        } else {
            return `https://map.naver.com/v5/directions/${startTm.x},${startTm.y},${endTm.x},${endTm.y}/car?c=${startTm.y},${startTm.x},15,0,0,0,dh`;
        }
    }

    // Generate Kakao Map URL with directions
    function generateKakaoMapUrl(startLat, startLng, endLat, endLng, storeName = '', placeId = '') {
        const encodedStartName = encodeURIComponent("현재 위치");
        const encodedEndName = encodeURIComponent(storeName || "목적지");
        
        if (placeId) {
            return `https://map.kakao.com/?map_type=TYPE_MAP&sName=${encodedStartName}&sX=${startLng}&sY=${startLat}&eName=${encodedEndName}&eX=${endLng}&eY=${endLat}&itemId=${placeId}`;
        } else {
            return `https://map.kakao.com/?map_type=TYPE_MAP&sName=${encodedStartName}&sX=${startLng}&sY=${startLat}&eName=${encodedEndName}&eX=${endLng}&eY=${endLat}`;
        }
    }

    // Generate Google Map URL with directions
    function generateGoogleMapUrl(startLat, startLng, endLat, endLng, storeName = '') {
        const encodedEndName = encodeURIComponent(storeName || "Destination");
        return `https://www.google.com/maps/dir/?api=1&origin=${startLat},${startLng}&destination=${endLat},${endLng}&travelmode=driving`;
    }

    // Add markers to map
    function addStoreMarkers(stores) {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        stores.forEach(store => {
            const iconHtml = `
                <div style="
                    background: ${getStoreColor(store.type)};
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 1.5rem;
                    border: 3px solid white;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                ">
                    <i class="${getStoreIcon(store.type)}"></i>
                </div>
            `;

            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'custom-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 50]
            });

            const marker = L.marker([store.lat, store.lng], { 
                icon: customIcon,
                title: store.name
            })
            .addTo(map)
            .bindPopup(createStorePopup(store))
            .on('click', function() {
                this.openPopup();
            });
            
            markers.push(marker);
        });

        if (stores.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    // Create store popup with routing options
    function createStorePopup(store) {
        const hasUserLocation = userLocation !== null;
        const routeBtnHtml = hasUserLocation ? 
            `<button class="map-btn route" onclick="showRouteToStore(${JSON.stringify(store).replace(/'/g, "\\'")})">
                <i class="fas fa-route"></i> Show Route
            </button>` : '';
        
        return `
            <div class="store-popup">
                <h3>${store.name}</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${store.address}</p>
                <p><i class="fas fa-clock"></i> ${store.hours}</p>
                <p><i class="fas fa-phone"></i> ${store.phone}</p>
                <div class="store-features" style="margin: 15px 0; font-size: 0.9rem;">
                    ${store.features.map(feature => 
                        `<span style="background: #f0f0f0; padding: 4px 10px; border-radius: 12px; margin: 3px; display: inline-block;">${feature}</span>`
                    ).join('')}
                </div>
                <div class="map-actions">
                    ${routeBtnHtml}
                    <button class="map-btn naver" onclick="openNaverMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}', '${store.naverPlaceId}')">
                        <i class="fas fa-external-link-alt"></i> Naver Map
                    </button>
                    <button class="map-btn kakao" onclick="openKakaoMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}', '${store.kakaoPlaceId}')">
                        <i class="fas fa-map"></i> Kakao Map
                    </button>
                </div>
            </div>
        `;
    }

    // Get store color based on type
    function getStoreColor(type) {
        const colors = {
            'flagship': '#ff006e',
            'experience': '#3a86ff',
            'service': '#28a745'
        };
        return colors[type] || '#1428a0';
    }

    // Get store icon based on type
    function getStoreIcon(type) {
        const icons = {
            'flagship': 'fas fa-star',
            'experience': 'fas fa-gamepad',
            'service': 'fas fa-tools'
        };
        return icons[type] || 'fas fa-store';
    }

    // Load stores into grid
    function loadStores(stores = currentStores) {
        const storesGrid = document.getElementById('storesGrid');
        
        if (storesGrid) {
            storesGrid.innerHTML = stores.map((store, index) => `
                <div class="store-card" style="animation-delay: ${index * 0.1}s">
                    <div class="store-badge" style="background: ${getStoreColor(store.type)}">${store.badge}</div>
                    <div class="store-header">
                        <div class="store-icon" style="background: ${getStoreColor(store.type)}">
                            <i class="${getStoreIcon(store.type)}"></i>
                        </div>
                        <div class="store-info">
                            <h3>${store.name}</h3>
                            <div class="store-type">${getStoreTypeLabel(store.type)}</div>
                            <div class="store-rating">
                                <div class="stars">
                                    ${generateStars(store.rating)}
                                </div>
                                <span>${store.rating} (${store.reviews})</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="store-details">
                        <div class="store-address" onclick="showRouteToStore(${JSON.stringify(store).replace(/'/g, "\\'")})">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${store.address}</span>
                        </div>
                        <div class="store-hours">
                            <i class="fas fa-clock"></i>
                            <span>${store.hours}</span>
                        </div>
                        <div class="store-phone">
                            <i class="fas fa-phone"></i>
                            <span>${store.phone}</span>
                        </div>
                    </div>
                    
                    <div class="store-features">
                        ${store.features.map(feature => `<span class="store-feature">${feature}</span>`).join('')}
                    </div>
                    
                    <div class="store-actions">
                        <button class="store-btn primary" onclick="showRouteToStore(${JSON.stringify(store).replace(/'/g, "\\'")})">
                            <i class="fas fa-route"></i> Get Directions
                        </button>
                        <button class="store-btn naver" onclick="openNaverMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}', '${store.naverPlaceId}')">
                            <i class="fas fa-external-link-alt"></i> Naver
                        </button>
                        <button class="store-btn kakao" onclick="openKakaoMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}', '${store.kakaoPlaceId}')">
                            <i class="fas fa-map"></i> Kakao
                        </button>
                    </div>
                </div>
            `).join('');
        }

        addStoreMarkers(stores);
        
        if (userLocation) {
            updateNearbyCount(stores);
        }
    }

    // Show route to store
    function showRouteToStore(store) {
        if (!userLocation) {
            showToast('Please enable location services first', 'error');
            getCurrentLocation();
            return;
        }
        
        currentRouteStore = store;
        
        // Set routing waypoints
        routingControl.setWaypoints([
            L.latLng(userLocation.lat, userLocation.lng),
            L.latLng(store.lat, store.lng)
        ]);
        
        // Show routing control
        routingControl.show();
        
        // Show route info panel
        showRouteInfoPanel(store);
        
        // Center map on route
        const bounds = L.latLngBounds([
            [userLocation.lat, userLocation.lng],
            [store.lat, store.lng]
        ]);
        map.fitBounds(bounds, {padding: [100, 100]});
        
        // Update route button text
        document.getElementById('routeBtn').innerHTML = '<i class="fas fa-times"></i> Clear Route';
        document.getElementById('routeBtn').onclick = clearRoute;
        
        showToast(`Showing route to ${store.name}`, 'info');
    }

    // Show route to nearest store
    function showRouteToNearestStore() {
        if (!userLocation) {
            showToast('Please enable location services first', 'error');
            getCurrentLocation();
            return;
        }
        
        // Find nearest store
        const storesWithDistance = samsungStores.map(store => ({
            ...store,
            distance: getDistance(userLocation.lat, userLocation.lng, store.lat, store.lng)
        })).sort((a, b) => a.distance - b.distance);
        
        if (storesWithDistance.length > 0) {
            showRouteToStore(storesWithDistance[0]);
        }
    }

    // Show route info panel
    function showRouteInfoPanel(store) {
        const routeInfoHtml = `
            <div class="route-info-panel">
                <div class="route-header">
                    <h3><i class="fas fa-route"></i> Route to ${store.name}</h3>
                    <button class="close-route-btn" onclick="clearRoute()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="route-details">
                    <div class="route-loading">
                        <div class="spinner"></div>
                        <span>Calculating route...</span>
                    </div>
                    <div class="route-stats" style="display: none;">
                        <div class="route-stat">
                            <i class="fas fa-road"></i>
                            <span id="routeDistance">-- km</span>
                            <span class="label">Distance</span>
                        </div>
                        <div class="route-stat">
                            <i class="fas fa-clock"></i>
                            <span id="routeTime">-- min</span>
                            <span class="label">Time</span>
                        </div>
                    </div>
                    <div class="route-actions">
                        <button class="route-action-btn naver" onclick="openNaverMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}', '${store.naverPlaceId}')">
                            <i class="fas fa-external-link-alt"></i> Naver Map
                        </button>
                        <button class="route-action-btn kakao" onclick="openKakaoMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}', '${store.kakaoPlaceId}')">
                            <i class="fas fa-map"></i> Kakao Map
                        </button>
                        <button class="route-action-btn google" onclick="openGoogleMapWithDirections(${store.lat}, ${store.lng}, '${store.name.replace(/'/g, "\\'")}')">
                            <i class="fab fa-google"></i> Google Maps
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const panel = document.getElementById('routeInfoPanel');
        panel.innerHTML = routeInfoHtml;
    }

    // Show route information
    function showRouteInfo(distance, time) {
        const distanceKm = (distance / 1000).toFixed(1);
        const timeMinutes = Math.round(time / 60);
        
        document.getElementById('routeDistance').textContent = `${distanceKm} km`;
        document.getElementById('routeTime').textContent = `${timeMinutes} min`;
        
        document.querySelector('.route-loading').style.display = 'none';
        document.querySelector('.route-stats').style.display = 'flex';
    }

    // Clear current route
    function clearRoute() {
        if (routingControl) {
            routingControl.setWaypoints([]);
            routingControl.hide();
        }
        
        currentRouteStore = null;
        
        // Clear route info panel
        document.getElementById('routeInfoPanel').innerHTML = '';
        
        // Reset route button
        document.getElementById('routeBtn').innerHTML = '<i class="fas fa-route"></i> Show Route';
        document.getElementById('routeBtn').onclick = showRouteToNearestStore;
        
        showToast('Route cleared', 'info');
    }

    // Open Naver Map with directions
    function openNaverMapWithDirections(endLat, endLng, storeName, placeId) {
        if (!userLocation) {
            showToast('Please enable location services first', 'error');
            getCurrentLocation();
            return;
        }
        
        const url = generateNaverMapUrl(
            userLocation.lat, userLocation.lng,
            endLat, endLng,
            storeName, placeId
        );
        window.open(url, '_blank', 'noopener,noreferrer');
        showToast(`Opening directions in Naver Map`, 'info');
    }

    // Open Kakao Map with directions
    function openKakaoMapWithDirections(endLat, endLng, storeName, placeId) {
        if (!userLocation) {
            showToast('Please enable location services first', 'error');
            getCurrentLocation();
            return;
        }
        
        const url = generateKakaoMapUrl(
            userLocation.lat, userLocation.lng,
            endLat, endLng,
            storeName, placeId
        );
        window.open(url, '_blank', 'noopener,noreferrer');
        showToast(`Opening directions in Kakao Map`, 'info');
    }

    // Open Google Map with directions
    function openGoogleMapWithDirections(endLat, endLng, storeName) {
        if (!userLocation) {
            showToast('Please enable location services first', 'error');
            getCurrentLocation();
            return;
        }
        
        const url = generateGoogleMapUrl(
            userLocation.lat, userLocation.lng,
            endLat, endLng,
            storeName
        );
        window.open(url, '_blank', 'noopener,noreferrer');
        showToast(`Opening directions in Google Maps`, 'info');
    }

    // Open Naver Map at current map center
    function openNaverMapAtCenter() {
        const center = map.getCenter();
        if (userLocation) {
            openNaverMapWithDirections(center.lat, center.lng, "Map Center");
        } else {
            const url = `https://map.naver.com/v5/?c=${wgs84ToTm128(center.lat, center.lng).y},${wgs84ToTm128(center.lat, center.lng).x},15,0,0,0,dh`;
            window.open(url, '_blank', 'noopener,noreferrer');
            showToast('Opening current view in Naver Map', 'info');
        }
    }

    // Open Kakao Map at current map center
    function openKakaoMapAtCenter() {
        const center = map.getCenter();
        if (userLocation) {
            openKakaoMapWithDirections(center.lat, center.lng, "Map Center");
        } else {
            const url = `https://map.kakao.com/?map_type=TYPE_MAP&lng=${center.lng}&lat=${center.lat}`;
            window.open(url, '_blank', 'noopener,noreferrer');
            showToast('Opening current view in Kakao Map', 'info');
        }
    }

    // Get current location
    function getCurrentLocation() {
        if (navigator.geolocation) {
            showToast('Getting your location...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Add user marker
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    
                    const userIconHtml = `
                        <div style="
                            background: linear-gradient(135deg, #3a86ff, #8338ec);
                            width: 60px;
                            height: 60px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.8rem;
                            border: 4px solid white;
                            box-shadow: 0 4px 20px rgba(58, 134, 255, 0.4);
                            animation: pulse 2s infinite;
                        ">
                            <i class="fas fa-user"></i>
                        </div>
                    `;
                    
                    const customUserIcon = L.divIcon({
                        html: userIconHtml,
                        className: 'user-marker',
                        iconSize: [60, 60],
                        iconAnchor: [30, 60]
                    });
                    
                    userMarker = L.marker([userLocation.lat, userLocation.lng], {
                        icon: customUserIcon,
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    // Center map on user location
                    map.setView([userLocation.lat, userLocation.lng], 13);
                    
                    // Get address from coordinates
                    getAddressFromCoordinates(userLocation.lat, userLocation.lng);
                    
                    // Update nearby count
                    updateNearbyCount(currentStores);
                    
                    showToast('Location found! Showing nearby stores', 'success');
                },
                function(error) {
                    console.error('Error getting location:', error);
                    let message = 'Could not get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Please allow location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            message += 'Location request timed out.';
                            break;
                        default:
                            message += 'Unknown error occurred.';
                            break;
                    }
                    showToast(message, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            showToast('Geolocation is not supported by your browser', 'error');
        }
    }

    // Get address from coordinates using reverse geocoding
    function getAddressFromCoordinates(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                let address = '';
                if (data.address) {
                    if (data.address.road) address += data.address.road + ', ';
                    if (data.address.neighbourhood) address += data.address.neighbourhood + ', ';
                    if (data.address.suburb) address += data.address.suburb + ', ';
                    if (data.address.city) address += data.address.city;
                }
                
                if (!address) {
                    address = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
                
                document.getElementById('currentLocationText').textContent = address;
                document.getElementById('locationInfo').style.display = 'flex';
            })
            .catch(error => {
                console.error('Error getting address:', error);
                document.getElementById('currentLocationText').textContent = 
                    `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                document.getElementById('locationInfo').style.display = 'flex';
            });
    }

    // Find nearest store
    function findNearestStore() {
        if (!userLocation) {
            showToast('Getting your location first...', 'info');
            getCurrentLocation();
            return;
        }
        
        // Find nearest store
        const storesWithDistance = currentStores.map(store => ({
            ...store,
            distance: getDistance(userLocation.lat, userLocation.lng, store.lat, store.lng)
        })).sort((a, b) => a.distance - b.distance);
        
        if (storesWithDistance.length > 0) {
            const nearestStore = storesWithDistance[0];
            
            // Highlight nearest store
            markers.forEach((marker, index) => {
                if (currentStores[index].id === nearestStore.id) {
                    marker.openPopup();
                    map.setView([nearestStore.lat, nearestStore.lng], 15);
                }
            });
            
            // Show notification
            showToast(`Nearest store: ${nearestStore.name} (${nearestStore.distance.toFixed(1)} km away)`, 'success');
            
            // Scroll to store in grid
            const storeCard = document.querySelector(`[onclick*="showRouteToStore(${nearestStore.id}"]`);
            if (storeCard) {
                storeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add highlight animation
                storeCard.style.animation = 'pulse 2s';
                setTimeout(() => {
                    storeCard.style.animation = '';
                }, 2000);
            }
        } else {
            showToast('No stores found', 'warning');
        }
    }

    // Calculate distance between two coordinates in km
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Show all stores
    function showAllStores() {
        map.fitBounds(new L.LatLngBounds(
            samsungStores.map(store => [store.lat, store.lng])
        ));
        
        showToast('Showing all Samsung stores', 'info');
    }

    // Filter stores by type
    function filterStores(type) {
        currentFilter = type;
        
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        if (type === 'all') {
            currentStores = [...samsungStores];
        } else {
            currentStores = samsungStores.filter(store => store.type === type);
        }
        
        loadStores(currentStores);
        showToast(`Showing ${currentStores.length} ${type} stores`, 'info');
    }

    // Search stores
    function searchStores(query) {
        if (!query.trim()) {
            filterStores(currentFilter);
            return;
        }
        
        const searchTerm = query.toLowerCase();
        currentStores = samsungStores.filter(store => 
            store.name.toLowerCase().includes(searchTerm) ||
            store.address.toLowerCase().includes(searchTerm) ||
            store.features.some(feature => feature.toLowerCase().includes(searchTerm))
        );
        
        loadStores(currentStores);
        
        if (currentStores.length === 0) {
            showToast('No stores found matching your search', 'warning');
        }
    }

    // Generate star rating
    function generateStars(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
            stars += '<i class="fas fa-star"></i>';
        }
        
        if (halfStar) {
            stars += '<i class="fas fa-star-half-alt"></i>';
        }
        
        for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="far fa-star"></i>';
        }
        
        return stars;
    }

    // Get store type label
    function getStoreTypeLabel(type) {
        const labels = {
            'flagship': 'Flagship Store',
            'experience': 'Experience Zone',
            'service': 'Service Center'
        };
        return labels[type] || 'Store';
    }

    // Update nearby stores count
    function updateNearbyCount(stores) {
        if (!userLocation) return;
        
        const nearbyStores = stores.filter(store => 
            getDistance(userLocation.lat, userLocation.lng, store.lat, store.lng) < 50
        );
        
        document.getElementById('nearbyCount').textContent = nearbyStores.length;
    }

    // Toast notification
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = toast.querySelector('i');
        
        toastMessage.textContent = message;
        toast.className = 'toast';
        toast.classList.add(type);
        
        if (type === 'error') {
            toastIcon.className = 'fas fa-exclamation-circle';
        } else if (type === 'warning') {
            toastIcon.className = 'fas fa-exclamation-triangle';
        } else if (type === 'info') {
            toastIcon.className = 'fas fa-info-circle';
        } else {
            toastIcon.className = 'fas fa-check-circle';
        }
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 4000);
    }

    // Scroll to top
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Pause any animations or clear route when tab is hidden
            if (routingControl) {
                clearRoute();
            }
        }
    });
</script>
{% endblock %}